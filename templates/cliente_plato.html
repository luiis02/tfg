{% extends "cliente_base.html" %}
{% block breadCrums %}
<div class="breadCrums">
    <h1 class="back">Volver a...</h1>
    <div class="bc">
        <a href="/carta" class="breadcrcla">Cartas</a>
        <p class="change">⮞</p>
        <a href="/secciones" class="breadcrcla">Secciones</a>
        <p class="change">⮞</p>
        <a href="#" class="breadcrcla">Actual</a>
    </div>
</div>
<hr class="separador">
{% endblock %}

{% block content %}
<div class="menu">
    <h1 class="tit1">En {{ nombre }} tenemos...</h1>
    <div class="submenu">
        {% for plato in platos %}
        <div class="platos" id="{{plato.nombre}}">
            <div class="subseccion1">
                <div id="namepla">
                    <b> {{ plato.nombre }} </b>
                </div>
                <div id="namepre">
                    {{ plato.precio }}€
                </div>

                <div class="contadortotal">
                    <button class="elimina" id="elimina{{ plato.nombre }}"
                        onclick="decrementCounter('cant{{ plato.nombre }}', '{{ plato.nombre }}')">-</button>

                    <b id="cant{{ plato.nombre }}">0</b>
                    <button class="aniade" id="aniade{{ plato.nombre }}"
                        onclick="incrementCounter('cant{{ plato.nombre }}', '{{ plato.nombre }}')">+</button>
                </div>
            </div>
            <div class="subseccion2">
                {{ plato.descripcion }}
            </div>

            <hr class="separapla">

        </div>

        {% endfor %}


    </div>
    {% endblock %}


    {% block scriptjs %}
    <script>
        // Función para incrementar el contador
        function incrementCounter(idd, idd2) {
            // Obtener el elemento del contador
            var contador = document.getElementById(idd);
            // Obtener el valor actual del contador y convertirlo a un número
            var valorActual = parseInt(contador.innerText);
            // Incrementar el valor del contador
            valorActual++;
            // Actualizar el valor mostrado en el contador
            contador.innerText = valorActual;
            getCount(idd2, valorActual);
        }

        // Función para decrementar el contador
        function decrementCounter(idd, idd2) {
            // Obtener el elemento del contador
            var contador = document.getElementById(idd);
            // Obtener el valor actual del contador y convertirlo a un número
            var valorActual = parseInt(contador.innerText);
            // Verificar si el valor actual es mayor que cero para evitar números negativos
            if (valorActual > 0) {
                // Decrementar el valor del contador
                valorActual--;
                // Actualizar el valor mostrado en el contador
                contador.innerText = valorActual;
            }
            getCount(idd2, valorActual);
        }

        function getCount(idd2, idd3) {
            var nombre = document.getElementById(idd2);
            var precio = nombre.querySelector("#namepre");
            var precioTexto = precio.innerText;
            var precioNumero = parseFloat(precioTexto.match(/[\d\.]+/)[0]);
            var valorCookie = obtenerCookie(idd2);

            if (valorCookie != null) {
                // Si la cookie existe, eliminarla y crear una nueva con el nuevo valor
                eliminarCookie(idd2);
                crearCookie(idd2, { cantidad: idd3, precio: precioNumero });

            } else {
                // Si la cookie no existe, crear una nueva
                crearCookie(idd2, { cantidad: idd3, precio: precioNumero });
            }

            var todasLasCookies = obtenerTodasLasCookies();
            var suma = 0;
            for (var nombreCookie in todasLasCookies) {
                var valorCookie = todasLasCookies[nombreCookie];
                if (valorCookie != 0 && nombreCookie != "total") {
                    var nombre = document.getElementById(nombreCookie);
                    if (nombre == null) {
                        continue;
                    }
                    var precio = nombre.querySelector("#namepre");
                    var precioTexto = precio.innerText;
                    var precioNumero = parseFloat(precioTexto.match(/[\d\.]+/)[0]);
                    suma += precioNumero * valorCookie;
                }
            }
            var textoaniadir = "(" + suma.toFixed(2) + "€)";
            document.getElementById("preciotot").innerText = textoaniadir;
            sumafinal();
        }

        function crearCookie(nombre, valor) {
            var fecha = new Date();
            fecha.setTime(fecha.getTime() + (20 * 60 * 1000));
            var expira = "expires=" + fecha.toUTCString();
            document.cookie = nombre + "=" + encodeURIComponent(JSON.stringify(valor)) + ";" + expira + ";path=/";
        }


        function obtenerCookie(nombre) {
            var nombreCookie = nombre + "=";
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i];
                while (cookie.charAt(0) == ' ') {
                    cookie = cookie.substring(1);
                }
                if (cookie.indexOf(nombreCookie) == 0) {
                    return cookie.substring(nombreCookie.length, cookie.length);
                }
            }
            return null;
        }

        function eliminarCookie(nombre) {
            crearCookie(nombre, "", -1);
        }

        function obtenerTodasLasCookies() {
            var cookies = document.cookie.split(';');
            var cookiesObj = {};
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                var partes = cookie.split('=');
                var nombre = partes[0];
                var valor = partes.slice(1).join('='); // Para manejar valores que contienen '='
                try {
                    // Intentar decodificar y analizar el valor como JSON
                    cookiesObj[nombre] = JSON.parse(decodeURIComponent(valor));
                } catch (error) {
                    // Si hay un error, el valor no es JSON, por lo que lo guardamos como está
                    cookiesObj[nombre] = decodeURIComponent(valor);
                }
            }
            return cookiesObj;
        }




        var todasLasCookies = obtenerTodasLasCookies();
        

        var suma = 0;
        for (var nombreCookie in todasLasCookies) {
            var valorCookie = todasLasCookies[nombreCookie];
            if (valorCookie != 0 && nombreCookie != "total" && valorCookie.cantidad != 0) {
                var nombre = document.getElementById(nombreCookie);
                var cant = document.getElementById("cant" + nombreCookie);
                if (cant == null) {
                    continue;
                }
                cant.innerText = valorCookie.cantidad;
                if (nombre == null) {
                    continue;
                }
                var precio = nombre.querySelector("#namepre");
                var precioTexto = precio.innerText;
                var precioNumero = parseFloat(precioTexto.match(/[\d\.]+/)[0]);
                suma += precioNumero * valorCookie.cantidad;
            }
        }





        var suma = 0;
        for (var nombreCookie in todasLasCookies) {
            var valorCookie = todasLasCookies[nombreCookie];
            if (valorCookie != 0 && nombreCookie != "total" && valorCookie.cantidad != 0) {
                var nombre = document.getElementById(nombreCookie);
                var cant = document.getElementById("cant" + nombreCookie);
                if (nombreCookie == "CocaCola") {
                    console.log("tEEEEEEEEEEEEEEEEEEEEEotal");
                    console.log(cant);
                    console.log("cant"+nombreCookie);
                }
                if (cant != null) {
                    
                    cant.innerText = valorCookie.cantidad;
                    if (nombre != null) {
                        var precio = nombre.querySelector("#namepre");
                    var precioTexto = precio.innerText;
                    var precioNumero = parseFloat(precioTexto.match(/[\d\.]+/)[0]);
                    suma += precioNumero * valorCookie.cantidad;   
                    }

                }
                
            }
        }




    </script>
    {% endblock %}